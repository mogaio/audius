(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{260:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.matrixClient=void 0;var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o=function(e){return e&&e.__esModule?e:{default:e}}(n(358));var s=t.matrixClient={client:null,firstEvent:{},syncFailCount:0,paginate:function(e){var t=this,n=this.client.getRoom(e).getTimelineSets()[0];return this.client.getEventTimeline(n,this.firstEvent[e]).then(function(e){return t.client.paginateEventTimeline(e,{backwards:!0})})},login:function(e,t,n,s){var r=this;return new Promise(function(c){r.client=o.default.createClient(i({},e,{baseUrl:"https://matrix.org",timelineSupport:!0})),r.client.on("Room.timeline",function(e){var t=e.event.content.body,i=e.event.room_id;i in r.firstEvent||(r.firstEvent[i]=e.event.event_id),"audiusMedia"===e.event.type?n("parseMatrixMessage",{roomId:i,eventId:e.event.event_id,message:e.event.content}):"org.rockdapus.audius"===e.event.type?"media"===e.event.content.type&&n("parseMatrixMessage",{roomId:i,eventId:e.event.event_id,message:e.event.content.data}):t&&n("parseMatrixMessage",{roomId:i,message:t})}),r.client.on("sync",function(e,t,n){if("ERROR"===e){if(n)return s("error",""+n.error.data.error),"M_UNKNOWN_TOKEN"===n.error.data.errcode&&s("toggleMatrixLoginModal",!0),void r.stop();r.syncFailCount>=3?(s("error","Could not connect to matrix more than 3 time. Disconnecting."),r.stop()):(s("error","Could not connect to matrix server. "+(r.syncFailCount?"Attempt "+r.syncFailCount:"")),r.syncFailCount++)}else"SYNCING"===e?r.syncFailCount=0:"PREPARED"===e&&c(r.client.getRooms())}),(void 0===t||t)&&r.client.setGuest(!0),r.client.startClient({initialSyncLimit:20})})},register:function(e){var t=e.username,n=e.password,i=e.sessionId,o=e.auth,s=e.bindThreepids,r=e.guestAccessToken;return this.client.register(t,n,i,o,s,r)},stop:function(){this.client.stopClient()},isGuest:function(){return this.client.isGuest()},joinRoom:function(e){return this.client.joinRoom(e)},leaveRoom:function(e){return this.client.leave(e)},sendEvent:function(e,t){return this.client.sendEvent(e,"org.rockdapus.audius",{type:"media",data:t})},redactEvent:function(e,t){return this.client.redactEvent(e,t)},sendMessage:function(e,t){return this.client.sendTextMessage(e,JSON.stringify(t))},setRoomAllowGuests:function(e,t){return this.client.sendStateEvent(e,"m.room.guest_access",{guest_access:t?"can_join":"forbidden"})},setRoomHistoryVisibility:function(e,t){if(["invited","joined","shared","world_readable"].includes(t))throw"setRoomHistoryVisibility unknown state "+t;return this.client.sendStateEvent(e,"m.room.history_visibility",{history_visibility:t})},setRoomName:function(e,t){return this.client.setRoomName(e,t)},setRoomVisibility:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.client.setRoomDirectoryVisibility(e,t?"private":"public")},createRoom:function(e){return this.client.createRoom(Object.assign(e,{initial_state:[{type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}},{type:"m.room.history_visibility",state_key:"",content:{history_visibility:"world_readable"}}]}))},listPublicRooms:function(){return this.client.publicRooms({filter:{generic_search_term:"audius"}})},getCredentialsWithPassword:function(e,t){return new Promise(function(n){o.default.createClient("https://matrix.org").loginWithPassword(e,t).then(function(e){n({accessToken:e.access_token,userId:e.user_id,deviceId:e.device_id})})})},getCredentials:function(){return new Promise(function(e){o.default.createClient("https://matrix.org").registerGuest().then(function(t){e({accessToken:t.access_token,userId:t.user_id,deviceId:t.device_id})})})}};window.matrixClient=s}}]);