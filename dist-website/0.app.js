(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{349:function(t,e,n){"use strict";n.r(e),n.d(e,"matrixClient",function(){return u});n(235);var i=n(236),r=n.n(i),o=n(25);function s(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{i||null==a.return||a.return()}finally{if(r)throw o}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var c=[],u={client:null,firstEvent:{},syncFailCount:0,started:!1,paginate:function(t){var e=this,n=this.client.getRoom(t);if(!n)throw{errcode:"PAGINATE_NO_ROOM"};var i=n.getTimelineSets()[0];return this.client.getEventTimeline(i,this.firstEvent[t]).then(function(t){return e.client.paginateEventTimeline(t,{backwards:!0})})},login:function(t,e,n,i){var s=this,u=Object(o.b)(function(){c.length&&(n("parseMatrixMessages",c),c=[])},250);return new Promise(function(n){var o=new r.a.WebStorageSessionStore(window.localStorage);s.client=r.a.createClient(function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),i.forEach(function(e){a(t,e,n[e])})}return t}({},t,{sessionStore:o,baseUrl:"https://matrix.org",timelineSupport:!0})),s.client.on("event",function(t){"m.room.join_rules"===t.getType()&&!0===s.started&&(i("setMatrixLoggedIn",s.client.getRooms()),console.log("this.client.getRooms()",s.client.getRooms()))}),s.client.on("Room.localEchoUpdated",function(t){var e=t.status,n=t._txnId;if("sent"===e){var r=t.getRoomId(),o="~".concat(r,":").concat(n),s=t.getId();i("updateMatrixEvent",{eventId:o,data:{eventId:s,status:e}})}}),s.client.on("Room.timeline",function(t){var e=t.getId(),n=t.getRoomId(),r=t.getSender(),o=t.getTs(),a=t.getType();n in s.firstEvent||(s.firstEvent[n]=e);var l={roomId:n,sender:r,createdAt:o,eventId:e,status:t.status};if("m.room.redaction"===a)i("matrixRedact",{eventId:t.event.redacts,roomId:n});else if("audiusMedia"===a)c.push(Object.assign(t.event.content,l));else if("org.rockdapus.audius"===a)"media"===t.event.content.type&&c.push(Object.assign(t.event.content.data,l));else if("m.room.message"===a){var d=t.getContent(),m=d.body,f="org.rockdapus.audius.media"in d;if("m.image"===d.msgtype){var g=s.client.mxcUrlToHttp(d.url,window.innerWidth,window.innerHeight,"scale");c.push(Object.assign({url:g,type:"text",parse:!1},l))}f&&c.push(Object.assign(d["org.rockdapus.audius.media"],l)),m&&c.push(Object.assign({body:m,type:"text",parse:!f},l))}u()}),s.client.on("sync",function(t,e,r){if("ERROR"===t){if(r)return r.error.data?(i("error","".concat(r.error.data.error)),"M_UNKNOWN_TOKEN"===r.error.data.errcode&&i("toggleMatrixLoginModal",!0),void s.stop()):void console.warn("event.error.data is missing: ",r.error);s.syncFailCount>=3?(i("error","Could not connect to matrix more than 3 time. Disconnecting."),s.stop()):(i("error","Could not connect to matrix server. ".concat(s.syncFailCount?"Attempt "+s.syncFailCount:"")),s.syncFailCount++)}else"SYNCING"===t?s.syncFailCount=0:"PREPARED"===t&&(s.started=!0,n(s.client.getRooms()))}),(void 0===e||e)&&s.client.setGuest(!0),s.client.initCrypto(),s.client.startClient({initialSyncLimit:4})})},register:function(t){var e=t.username,n=t.password,i=t.sessionId,r=t.auth,o=t.bindThreepids,s=t.guestAccessToken;return this.client.register(e,n,i,r,o,s)},stop:function(){this.client.stopClient()},getAvatarUrl:function(t){var e=this;return this.client.getProfileInfo(t,"avatar_url").then(function(t){return t.avatar_url?e.client.mxcUrlToHttp(t.avatar_url,void 0,100):null})},isGuest:function(){return this.client.isGuest()},joinRoom:function(t){return this.client.joinRoom(t)},leaveRoom:function(t){return this.client.leave(t)},forgetRoom:function(t){return console.log("roomIdOrAlias",t),this.client.forget(t)},sendMediaMessage:function(t,e,n){var i=new Set(["eventId","roomId","sender"]),r=Object.entries(e).reduce(function(t,e){var n=s(e,2),r=n[0],o=n[1];return i.has(r)||Object.assign(t,a({},r,o)),t},{});return this.client.sendEvent(t,"m.room.message",{body:n,msgtype:"m.text","org.rockdapus.audius.media":r})},sendMessage:function(t,e){return this.client.sendTextMessage(t,e)},redactEvent:function(t,e){return this.client.redactEvent(t,e)},setRoomAllowGuests:function(t,e){return this.client.sendStateEvent(t,"m.room.guest_access",{guest_access:e?"can_join":"forbidden"})},setRoomHistoryVisibility:function(t,e){if(["invited","joined","shared","world_readable"].includes(e))throw"setRoomHistoryVisibility unknown state ".concat(e);return this.client.sendStateEvent(t,"m.room.history_visibility",{history_visibility:e})},setRoomName:function(t,e){return this.client.setRoomName(t,e)},setRoomVisibility:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.client.setRoomDirectoryVisibility(t,e?"private":"public")},invite:function(t,e){return this.client.invite(e,t)},createDirectMessageRoom:function(t){return this.client.createRoom({preset:"trusted_private_chat",invite:[t],is_direct:!0})},createRoom:function(t){return this.client.createRoom(Object.assign(t,{initial_state:[{type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}},{type:"m.room.history_visibility",state_key:"",content:{history_visibility:"world_readable"}}]}))},searchRoom:function(t){var e=new Set(["!hUkskxfIMmwAQuZIjz:matrix.org"]);return this.client.publicRooms({filter:{generic_search_term:t}}).then(function(t){return t.chunk.filter(function(t){var n=t.room_id;return!e.has(n)})})},getCredentialsWithPassword:function(t,e){return new Promise(function(n){r.a.createClient("https://matrix.org").loginWithPassword(t,e).then(function(t){n({accessToken:t.access_token,userId:t.user_id,deviceId:t.device_id})})})},getCredentials:function(){return new Promise(function(t){r.a.createClient("https://matrix.org").registerGuest().then(function(e){t({accessToken:e.access_token,userId:e.user_id,deviceId:e.device_id})})})}};window.matrixClient=u}}]);