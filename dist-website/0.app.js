(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{274:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.matrixClient=void 0;var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},s=function(e){return e&&e.__esModule?e:{default:e}}(n(382)),r=n(83);var o=[],a=new Set,c=t.matrixClient={client:null,firstEvent:{},syncFailCount:0,paginate:function(e){var t=this,n=this.client.getRoom(e);if(!n)throw{errcode:"PAGINATE_NO_ROOM"};var i=n.getTimelineSets()[0];return this.client.getEventTimeline(i,this.firstEvent[e]).then(function(e){return t.client.paginateEventTimeline(e,{backwards:!0})})},login:function(e,t,n,c){var u=this,l=(0,r.throttle)(function(){o.length&&(n("parseMatrixMessages",o),o=[])},250);return new Promise(function(n){u.client=s.default.createClient(i({},e,{baseUrl:"https://matrix.org",timelineSupport:!0})),u.client.on("Room.timeline",function(e){var t=e.event.event_id;if(!a.has(t)){a.add(t);var n=e.event.room_id,i=e.event.sender||e.event.user_id,s=e.event.origin_server_ts,r=e.event.type;n in u.firstEvent||(u.firstEvent[n]=t);var c={roomId:n,sender:i,createdAt:s,eventId:t};if("audiusMedia"===r)o.push(Object.assign(e.event.content,c));else if("org.rockdapus.audius"===r)"media"===e.event.content.type&&o.push(Object.assign(e.event.content.data,c));else if("m.room.message"===r){var d=e.event.content,m=d.body,v=d.msgtype,f=d.media;m&&o.push(Object.assign({body:m,type:"text",msgtype:v},c)),"m.audius.media"===v&&o.push(Object.assign(f,c))}void 0,l()}}),u.client.on("sync",function(e,t,i){if("ERROR"===e){if(i)return c("error",""+i.error.data.error),"M_UNKNOWN_TOKEN"===i.error.data.errcode&&c("toggleMatrixLoginModal",!0),void u.stop();u.syncFailCount>=3?(c("error","Could not connect to matrix more than 3 time. Disconnecting."),u.stop()):(c("error","Could not connect to matrix server. "+(u.syncFailCount?"Attempt "+u.syncFailCount:"")),u.syncFailCount++)}else"SYNCING"===e?u.syncFailCount=0:"PREPARED"===e&&n(u.client.getRooms())}),(void 0===t||t)&&u.client.setGuest(!0),u.client.startClient({initialSyncLimit:5})})},register:function(e){var t=e.username,n=e.password,i=e.sessionId,s=e.auth,r=e.bindThreepids,o=e.guestAccessToken;return this.client.register(t,n,i,s,r,o)},stop:function(){this.client.stopClient()},getAvatarUrl:function(e){var t=this;return this.client.getProfileInfo(e,"avatar_url").then(function(e){return e.avatar_url?t.client.mxcUrlToHttp(e.avatar_url,100):null})},isGuest:function(){return this.client.isGuest()},joinRoom:function(e){return this.client.joinRoom(e)},leaveRoom:function(e){return this.client.leave(e)},sendMediaMessage:function(e,t,n){return this.client.sendEvent(e,"m.room.message",{body:n,msgtype:"m.audius.media",media:t})},sendMessage:function(e,t){return console.log("sendMessage media",t),this.client.sendTextMessage(e,t)},redactEvent:function(e,t){return this.client.redactEvent(e,t)},setRoomAllowGuests:function(e,t){return this.client.sendStateEvent(e,"m.room.guest_access",{guest_access:t?"can_join":"forbidden"})},setRoomHistoryVisibility:function(e,t){if(["invited","joined","shared","world_readable"].includes(t))throw"setRoomHistoryVisibility unknown state "+t;return this.client.sendStateEvent(e,"m.room.history_visibility",{history_visibility:t})},setRoomName:function(e,t){return this.client.setRoomName(e,t)},setRoomVisibility:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.client.setRoomDirectoryVisibility(e,t?"private":"public")},createRoom:function(e){return this.client.createRoom(Object.assign(e,{initial_state:[{type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}},{type:"m.room.history_visibility",state_key:"",content:{history_visibility:"world_readable"}}]}))},listPublicRooms:function(){return this.client.publicRooms({filter:{generic_search_term:"audius"}})},getCredentialsWithPassword:function(e,t){return new Promise(function(n){s.default.createClient("https://matrix.org").loginWithPassword(e,t).then(function(e){n({accessToken:e.access_token,userId:e.user_id,deviceId:e.device_id})})})},getCredentials:function(){return new Promise(function(e){s.default.createClient("https://matrix.org").registerGuest().then(function(t){e({accessToken:t.access_token,userId:t.user_id,deviceId:t.device_id})})})}};window.matrixClient=c}}]);