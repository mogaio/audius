(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{274:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.matrixClient=void 0;var i=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{!i&&a.return&&a.return()}finally{if(r)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t};n(382);var o=function(t){return t&&t.__esModule?t:{default:t}}(n(383)),s=n(83);var a=[],c=e.matrixClient={client:null,firstEvent:{},syncFailCount:0,paginate:function(t){var e=this,n=this.client.getRoom(t);if(!n)throw{errcode:"PAGINATE_NO_ROOM"};var i=n.getTimelineSets()[0];return this.client.getEventTimeline(i,this.firstEvent[t]).then(function(t){return e.client.paginateEventTimeline(t,{backwards:!0})})},login:function(t,e,n,i){var c=this,u=(0,s.throttle)(function(){a.length&&(n("parseMatrixMessages",a),a=[])},250);return new Promise(function(n){c.client=o.default.createClient(r({},t,{baseUrl:"https://matrix.org",timelineSupport:!0})),c.client.on("Room.localEchoUpdated",function(t){var e=t.status,n=t._txnId;if("sent"===e){var r="~"+t.getRoomId()+":"+n,o=t.getId();i("updateMatrixEvent",{eventId:r,data:{eventId:o,status:e}})}}),c.client.on("Room.timeline",function(t){var e=t.getId(),n=t.getRoomId(),r=t.getSender(),o=t.getTs(),s=t.getType();n in c.firstEvent||(c.firstEvent[n]=e);var l={roomId:n,sender:r,createdAt:o,eventId:e,status:t.status};if("m.room.redaction"===s)i("matrixRedact",{eventId:t.event.redacts,roomId:n});else if("audiusMedia"===s)a.push(Object.assign(t.event.content,l));else if("org.rockdapus.audius"===s)"media"===t.event.content.type&&a.push(Object.assign(t.event.content.data,l));else if("m.room.message"===s){var d=t.getContent(),m=d.body,f="org.rockdapus.audius.media"in d;if("m.image"===d.msgtype){var v=c.client.mxcUrlToHttp(d.url,window.innerWidth,window.innerHeight,"scale");a.push(Object.assign({url:v,type:"text",parse:!1},l))}f&&a.push(Object.assign(d["org.rockdapus.audius.media"],l)),m&&a.push(Object.assign({body:m,type:"text",parse:!f},l))}u()}),c.client.on("sync",function(t,e,r){if("ERROR"===t){if(r)return i("error",""+r.error.data.error),"M_UNKNOWN_TOKEN"===r.error.data.errcode&&i("toggleMatrixLoginModal",!0),void c.stop();c.syncFailCount>=3?(i("error","Could not connect to matrix more than 3 time. Disconnecting."),c.stop()):(i("error","Could not connect to matrix server. "+(c.syncFailCount?"Attempt "+c.syncFailCount:"")),c.syncFailCount++)}else"SYNCING"===t?c.syncFailCount=0:"PREPARED"===t&&n(c.client.getRooms())}),(void 0===e||e)&&c.client.setGuest(!0),c.client.startClient({initialSyncLimit:4})})},register:function(t){var e=t.username,n=t.password,i=t.sessionId,r=t.auth,o=t.bindThreepids,s=t.guestAccessToken;return this.client.register(e,n,i,r,o,s)},stop:function(){this.client.stopClient()},getAvatarUrl:function(t){var e=this;return this.client.getProfileInfo(t,"avatar_url").then(function(t){return t.avatar_url?e.client.mxcUrlToHttp(t.avatar_url,void 0,100):null})},isGuest:function(){return this.client.isGuest()},joinRoom:function(t){return this.client.joinRoom(t)},leaveRoom:function(t){return this.client.leave(t)},sendMediaMessage:function(t,e,n){var r=new Set(["eventId","roomId","sender"]),o=Object.entries(e).reduce(function(t,e){var n=i(e,2),o=n[0],s=n[1];return r.has(o)||Object.assign(t,function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}({},o,s)),t},{});return this.client.sendEvent(t,"m.room.message",{body:n,msgtype:"m.text","org.rockdapus.audius.media":o})},sendMessage:function(t,e){return this.client.sendTextMessage(t,e)},redactEvent:function(t,e){return this.client.redactEvent(t,e)},setRoomAllowGuests:function(t,e){return this.client.sendStateEvent(t,"m.room.guest_access",{guest_access:e?"can_join":"forbidden"})},setRoomHistoryVisibility:function(t,e){if(["invited","joined","shared","world_readable"].includes(e))throw"setRoomHistoryVisibility unknown state "+e;return this.client.sendStateEvent(t,"m.room.history_visibility",{history_visibility:e})},setRoomName:function(t,e){return this.client.setRoomName(t,e)},setRoomVisibility:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.client.setRoomDirectoryVisibility(t,e?"private":"public")},invite:function(t,e){return this.client.invite(t,e)},createDirectMessageRoom:function(t){return this.client.createRoom({preset:"trusted_private_chat",invite:[t],is_direct:!0})},createRoom:function(t){return this.client.createRoom(Object.assign(t,{initial_state:[{type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}},{type:"m.room.history_visibility",state_key:"",content:{history_visibility:"world_readable"}}]}))},searchRoom:function(t){var e=new Set(["!hUkskxfIMmwAQuZIjz:matrix.org"]);return this.client.publicRooms({filter:{generic_search_term:t}}).then(function(t){return t.chunk.filter(function(t){var n=t.room_id;return!e.has(n)})})},getCredentialsWithPassword:function(t,e){return new Promise(function(n){o.default.createClient("https://matrix.org").loginWithPassword(t,e).then(function(t){n({accessToken:t.access_token,userId:t.user_id,deviceId:t.device_id})})})},getCredentials:function(){return new Promise(function(t){o.default.createClient("https://matrix.org").registerGuest().then(function(e){t({accessToken:e.access_token,userId:e.user_id,deviceId:e.device_id})})})}};window.matrixClient=c}}]);