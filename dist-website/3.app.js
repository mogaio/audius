(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{141:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r(330);Object.defineProperty(t,"actions",{enumerable:!0,get:function(){return o.actions}});var n=r(331);Object.defineProperty(t,"mutations",{enumerable:!0,get:function(){return n.mutations}});var i=r(67);Object.defineProperty(t,"presistMutation",{enumerable:!0,get:function(){return i.presistMutation}});var a=r(85);Object.defineProperty(t,"state",{enumerable:!0,get:function(){return a.state}})},330:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.actions=void 0;var o=r(2),n=r(48),i=void 0,a=/(https?:\/\/[^\s]+)/g;function s(e){return e.replace(a,'<a href="$1" target="_blank">$1</a>')}t.actions={initMatrix:function(e){var t=e.commit,o=e.state,n=e.dispatch;Promise.all([r.e(1),r.e(0)]).then(r.t.bind(null,274,7)).then(function(e){i=e.matrixClient,o.hasCredentials?o.matrixLoggedIn||i.login(o.credentials,o.isGuest,n,t).then(function(e){t("setMatrixLoggedIn",e)}).catch(function(e){return t("error",e+" initMatrix with credentials")}):i.getCredentials().then(function(e){return t("setMatrixCredentials",{credentials:e,isGuest:!0})}).then(function(){return i.login(o.credentials,o.isGuest,n,t)}).then(function(e){t("setMatrixLoggedIn",e),n("updatePublicRooms")}).catch(function(e){return t("error",e+"1")})})},loginMatrixWithPassword:function(e,t){var o=e.commit,n=e.state,a=e.dispatch,s=t.username,c=t.password;Promise.all([r.e(1),r.e(0)]).then(r.t.bind(null,274,7)).then(function(e){(i=e.matrixClient).getCredentialsWithPassword(s,c).then(function(e){return o("setMatrixCredentials",{credentials:e,isGuest:!1})}).then(function(){return i.login(n.credentials,n.isGuest,a,o)}).then(function(e){o("setMatrixLoggedIn",e)}).catch(function(e){return o("error",e+"3")})})},registerMatrixUser:function(e,t){var o=e.state,n=e.commit,a=e.dispatch;Object.assign({sessionId:"",auth:void 0,bindThreepids:{email:!0},guestAccessToken:void 0},t),Promise.all([r.e(1),r.e(0)]).then(r.t.bind(null,274,7)).then(function(e){(i=e.matrixClient).register(t).then(function(e){return n("setMatrixCredentials",{credentials:e,isGuest:!1})}).then(function(){return i.login(o.credentials,o.isGuest,a,n)}).catch(function(e){return n("error","Register: "+e)})})},matrixSendText:function(e,t){e.state,e.rootState;var r=e.commit,o=t.roomId,n=t.message;i.sendMessage(o,n).catch(function(e){return r("error","Posting message to matrix room failed. "+e)})},matrixSend:function(e,t){var r=e.state,a=e.rootState,s=e.commit,c=t.itemId,u=t.roomId,d=t.media||(0,n.getMediaEntity)(a,c);r.sources[u].playList.some(function(e){return e.id===d.id})?s("error","The media item was already posted."):i.sendMediaMessage(u,d,(0,o.getMediaLink)(d)).catch(function(e){return s("error","Posting media to matrix room failed. "+e)})},matrixRedact:function(e,t){var r=e.state,o=e.commit;t.roomId&&t.eventId?i.redactEvent(t.roomId,t.eventId).then(function(){o("updateMatrixRoom",{roomId:t.roomId,values:{playList:r.sources[t.roomId].playList.filter(function(e){return e.eventId!==t.eventId})}})}).catch(function(e){return o("error","Could not remove media from matrix room. "+e)}):o("error","Not enough information to remove media from matrix room.")},matrixLoadMore:function(e,t){var r=e.state,o=e.commit;e.rootState.isLoading[t]||r.lastPageReached[t]||(o("toggleIsLoading",{id:t,loading:!0}),setTimeout(function(){o("toggleIsLoading",{id:t,loading:!1})},4e4),i.paginate(t).then(function(e){e?o("increasePaginationIndex",t):(o("error","You reached the last page of this room."),o("setLastPageReached",t))}).catch(function(){o("error","Paginating matrix room failed")}).finally(function(){o("toggleIsLoading",{id:t,loading:!1})}))},joinMatrixRoom:function(e,t){var r=e.commit,o=e.dispatch,n=t.id,a=t.name;r("toggleMatrixRoomDirectory",!1),i.joinRoom(n).then(function(e){e.name=a||n,r("joinRoom",e),r("selectMediaSource",{type:"matrix",id:e.roomId}),r("setLeftMenuTab","matrix"),setTimeout(function(){o("matrixLoadMore",e.roomId)},2e3)}).catch(function(e){"PAGINATE_NO_ROOM"!==e.errcode&&("Guest access not allowed"===e.message&&r("toggleMatrixLoginModal",!0),"M_CONSENT_NOT_GIVEN"===e.errcode?(r("setLeftMenuTab","matrix"),r("toggleMatrixConsentModal",{toggleState:!0,message:s(e.message.replace(/\.$/,""))})):r("error","Could not join room: "+e.message))})},createMatrixRoom:function(e,t){var r=e.commit;i.createRoom(t).then(function(e){e.name=t.name,e.roomId=e.room_id,r("setMatrixLoggedIn",[e]),r("updateMatrixRoom",{roomId:e.roomId,values:{isHidden:"private"===t.visibility}}),r("toggleMatrixRoomModal",!1),r("selectMediaSource",{type:"matrix",id:e.room_id}),r("setLeftMenuTab","radio")}).catch(function(e){r("error","Could not create room. "+e)})},setRoomName:function(e,t){var r=e.commit,o=t.id,n=t.name;i.setRoomName(o,n).then(function(){return r("updateMatrixRoom",{roomId:o,values:{name:n}})}).catch(function(e){return r("error","Could not rename matrix room: "+e)})},setRoomTag:function(e,t){var r=e.commit,o=t.roomId,n=t.tagName;i.setRoomTag(o,n).then(function(){return r("error",{error:"room tag is set",type:"success"})}).catch(function(e){return r("error","Could not set tagName. "+e)})},updateRoomOptions:function(e,t){var r=e.commit;"allowGuests"in t&&i.setRoomAllowGuests(t.id,t.allowGuests).then(function(){return r("updateMatrixRoom",{roomId:t.id,values:{allowGuests:t.allowGuests}})}).catch(function(e){return r("error","Could not set allow guests to "+t.allowGuests+". "+e)}),"isHidden"in t&&i.setRoomVisibility(t.id,t.isHidden).then(function(){return r("updateMatrixRoom",{roomId:t.id,values:{isHidden:t.isHidden}})}).catch(function(e){return r("error","Could not set room private. "+e)})},leaveMatrixRoom:function(e,t){var r=e.commit;r("deleteMatrixRoom",t),i.leaveRoom(t).catch(function(){return r("error","Leaving matrix room failed")})},updatePublicRooms:function(e){var t=e.commit,r=new Set(["!hUkskxfIMmwAQuZIjz:matrix.org"]);i.listPublicRooms().then(function(e){var o=e.chunk.filter(function(e){var t=e.room_id;return!r.has(t)});t("setPublicRooms",o.map(function(e){return{name:e.name.replace("[Audius]",""),id:e.room_id,numberOfMembers:e.num_joined_members,topic:e.topic}}))}).catch(function(e){return t("error","Getting public matrix Rooms failed. "+e)})},matrixLogout:function(e){var t=e.commit;i.logout(),t("matrixLogout")},parseMatrixMessages:function(e,t){e.state;var r=e.commit,n=e.rootState;t.forEach(function(e){var t=e.type,i=e.body,a=e.msgtype;i&&(e.body=s(i)),"text"===t&&"m.audius.media"!==a?(0,o.findMediaText)(i,n.youtubeApiKey,n.mediaIndex).then(function(t){var o=t.mediaList,n=t.newMedia;n.length&&r("updateMediaIndex",n),o.forEach(function(t){var o=Object.assign({},e,t);delete o.body,r("addChatlog",[o])})}):"text"!==t&&(e.id in n.mediaIndex||r("updateMediaIndex",e))}),r("addChatlog",t)}}},331:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mutations=void 0;var o=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],o=!0,n=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(o=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);o=!0);}catch(e){n=!0,i=e}finally{try{!o&&s.return&&s.return()}finally{if(n)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=r(2);function i(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var a=function(){return JSON.parse(JSON.stringify({name:"",playList:[],archive:[],members:0}))};var s=/@(.+):matrix.org/;function c(e,t){var r=t.reduce(function(e,t){return t.currentState&&Object.assign(e,t.currentState.members),e},{});Object.values(r).forEach(function(t){if(!t)return{userid:null};var r=t.userId,o=t.name,i=o.match(s),a={userId:r,name:i?i[1]:o,nameColor:function(e){return"hsl("+(0,n.hashCode)(e)%360+",100%,30%)"}(o)};r in e.membersIndex?Object.assign(e.membersIndex[r],a):e.membersIndex[r]=a}),e.membersIndex=Object.assign({},e.membersIndex)}t.mutations={recoverState_matrix:function(e,t){Object.assign(e,t)},setPublicRooms:function(e,t){e.publicRooms=t},setMatrixCredentials:function(e,t){var r=t.credentials,o=t.isGuest;e.hasCredentials=!0,e.credentials=r,e.isGuest=o},joinRoom:function(e,t){var r=t.roomId;r in e.sources||(e.sources[r]=Object.assign({},a(),{name:t.name}),e.sourcesOrdered=[r].concat(i(e.sourcesOrdered)))},setMemberInfo:function(e,t){Object.assign(e.membersIndex[t.userId],t),e.membersIndex=Object.assign({},e.membersIndex)},setMatrixLoggedIn:function(e,t){e.showMatrixLoginModal=!1,e.matrixLoggedIn=!0,function(e,t){var r=e.credentials.userId;if(t.forEach(function(t){var n=t.roomId;if(n in e.sources||(e.sources[n]=Object.assign({},a(),{roomId:n,name:t.name})),t.currentState){e.sources[n].members=Object.entries(t.currentState.members).map(function(e){var t=o(e,2);return{id:t[0],powerLevel:t[1].powerLevel}});var i=t.currentState.members[r]||{};e.sources[n].isAdmin=i.powerLevel>=100;try{var s=o(t.currentState.events["m.room.aliases"]["matrix.org"].event.content.aliases,1);e.sources[n].alias=s[0]}catch(e){console.warn("could not get alias, well it is bad code anyway")}}e.sourcesOrdered.includes(n)||e.sourcesOrdered.unshift(n),e.sources[n].name===t.name||t.name.includes(":matrix.org")||(e.sources[n].name=t.name)}),t.length>=1){var n=new Set(t.map(function(e){return e.roomId}));e.sourcesOrdered=[].concat(i(e.sourcesOrdered.filter(function(e){return n.has(e)})),i(t.filter(function(t){var r=t.roomId;return!e.sourcesOrdered.includes(r)})))}}(e,t),c(e,t)},toggleMatrixLoginModal:function(e,t){e.showMatrixLoginModal=void 0!==t?t:!e.showMatrixLoginModal},toggleMatrixRoomModal:function(e,t){e.createMatrixRoomModal=void 0!==t?t:!e.createMatrixRoomModal},toggleMatrixConsentModal:function(e,t){if("boolean"!=typeof t){var r=t.toggleState,o=t.message;o&&(e.matrixConsentMessage=o),e.showMatrixConsentModal=void 0!==r?r:!e.showMatrixConsentModal}else e.showMatrixConsentModal=t},toggleMatrixRoomDirectory:function(e,t){e.showMatrixRoomDirectory=void 0!==t?t:!e.showMatrixRoomDirectory},matrixRemoveAccount:function(e){Object.assign(e,{hasCredentials:!1,matrixLoggedIn:!1,isGuest:null,credentials:{accessToken:"",userId:"",deviceId:""}})},matrixLogout:function(e){e.matrixLoggedIn=!1,e.currentMatrixRoom=""},deleteMatrixRoom:function(e,t){e.sourcesOrdered=e.sourcesOrdered.filter(function(e){return e!==t}),delete e.sources[t]},toggleHideRoom:function(e,t){Object.assign(e.sources[t],{hidden:!e.sources[t].hidden}),e.sources=Object.assign({},e.sources)},updateMatrixRoom:function(e,t){var r=t.roomId,o=t.values;e.sources[r]||(e.sources[r]=Object.assign({},a(),{name:r})),e.sources[r]=Object.assign({},e.sources[r],o),e.sources=Object.assign({},e.sources)},setLastPageReached:function(e,t){e.lastPageReached[t]=!0},addChatlog:function(e,t){t.forEach(function(t){var r=t.roomId,o=t.type;if(r in e.sources||(e.sources[r]=Object.assign({},a(),{roomId:r,name:r})),"text"!==o&&!e.sources[r].playList.some(function(e){var r=e.eventId;return t.eventId===r})){var n=e.sources[r],i=n.playList,s=n.archive;for(i.push(t),i.sort(u),i.reverse();i.length>3e3;){var c=i.shift();s.push(c.id)}}var d=Object.assign({},t,{childEvent:null,parentEvent:null});if(r in e.chatLog){var m=e.chatLog[r];m.push(d),m.sort(u),m.forEach(function(e,t){if(t){var r=m[t-1];r.createdAt===e.createdAt&&("text"!==r.type?++r.createdAt:++e.createdAt),"text"===r.type&&"text"===e.type&&r.sender===e.sender?(r.childEvent=e,e.parentEvent=r):(r.childEvent=null,e.parentEvent=null)}})}else e.chatLog[r]=[d]}),e.sources=Object.assign({},e.sources),e.chatLog=Object.assign({},e.chatLog)}};var u=function(e,t){return e.createdAt<=t.createdAt?-1:1}}}]);