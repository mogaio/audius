(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{368:function(e,t,o){"use strict";o.r(t);var r,n=o(1),i=o(3);function a(e,t,o,r){t.isLoading[e]||(o("toggleIsLoading",{id:e,loading:!0}),setTimeout(function(){o("toggleIsLoading",{id:e,loading:!1})},r||4e4))}var s={initMatrix:function(e){var t=e.commit,n=e.state,i=e.dispatch;Promise.all([o.e(1),o.e(0)]).then(o.bind(null,348)).then(function(e){r=e.matrixClient,n.hasCredentials?n.matrixLoggedIn||r.login(n.credentials,n.isGuest,i,t).then(function(e){t("setMatrixLoggedIn",e)}).catch(function(e){return t("error","".concat(e," initMatrix with credentials"))}):r.getCredentials().then(function(e){return t("setMatrixCredentials",{credentials:e,isGuest:!0})}).then(function(){return r.login(n.credentials,n.isGuest,i,t)}).then(function(e){t("setMatrixLoggedIn",e),i("updatePublicRooms")}).catch(function(e){return t("error","".concat(e,"1"))})})},loginMatrixWithPassword:function(e,t){var n=e.commit,i=e.state,a=e.dispatch,s=t.username,c=t.password;Promise.all([o.e(1),o.e(0)]).then(o.bind(null,348)).then(function(e){(r=e.matrixClient).getCredentialsWithPassword(s,c).then(function(e){return n("setMatrixCredentials",{credentials:e,isGuest:!1})}).then(function(){return r.login(i.credentials,i.isGuest,a,n)}).then(function(e){n("setMatrixLoggedIn",e)}).catch(function(e){return n("error","".concat(e,"3"))})})},registerMatrixUser:function(e,t){var n=e.state,i=e.commit,a=e.dispatch;Object.assign({sessionId:"",auth:void 0,bindThreepids:{email:!0},guestAccessToken:void 0},t),Promise.all([o.e(1),o.e(0)]).then(o.bind(null,348)).then(function(e){(r=e.matrixClient).register(t).then(function(e){return i("setMatrixCredentials",{credentials:e,isGuest:!1})}).then(function(){return r.login(n.credentials,n.isGuest,a,i)}).catch(function(e){return i("error","Register: ".concat(e))})})},matrixSendText:function(e,t){e.state,e.rootState;var o=e.commit,n=t.roomId,i=t.message;r.sendMessage(n,i).catch(function(e){return o("error","Posting message to matrix room failed. ".concat(e))})},matrixSend:function(e,t){var o=e.state,a=e.rootState,s=e.commit,c=t.itemId,u=t.roomId,d=t.media,m=t.silent,l=d||Object(i.d)(a,c);if(o.sources[u].playList.some(function(e){return e.id===l.id})){var f="The media item was already posted.";m?window.console.warn(f):s("error",f)}else r.sendMediaMessage(u,l,Object(n.g)(l)).catch(function(e){return s("error","Posting media to matrix room failed. ".concat(e))})},matrixRedact:function(e,t){var o=e.state,n=e.commit;t.roomId&&t.eventId?r.redactEvent(t.roomId,t.eventId).then(function(){n("updateMatrixRoom",{roomId:t.roomId,values:{playList:o.sources[t.roomId].playList.filter(function(e){return e.eventId!==t.eventId})}})}).catch(function(e){return n("error","Could not remove media from matrix room. ".concat(e))}):n("error","Not enough information to remove media from matrix room.")},matrixLoadMore:function(e,t){var o=e.state,n=e.commit,i=e.rootState;o.lastPageReached[t]||(a(t,i,n),r.paginate(t).then(function(e){e?n("increasePaginationIndex",t):(n("error","You reached the last page of this room."),n("setLastPageReached",t))}).catch(function(){n("error","Paginating matrix room failed")}).finally(function(){n("toggleIsLoading",{id:t,loading:!1})}))},joinMatrixRoom:function(e,t){var o=e.commit,i=e.dispatch,a=t.id,s=t.name;o("toggleMatrixRoomDirectory",!1),r.joinRoom(a).then(function(e){e.name=s||a,o("joinRoom",e),o("selectMediaSource",{type:"matrix",id:e.roomId}),o("setLeftMenuTab","matrix"),setTimeout(function(){i("matrixLoadMore",e.roomId)},2e3)}).catch(function(e){"PAGINATE_NO_ROOM"!==e.errcode&&("Guest access not allowed"===e.message&&o("toggleMatrixLoginModal",!0),"M_CONSENT_NOT_GIVEN"===e.errcode?(o("setLeftMenuTab","matrix"),o("toggleMatrixConsentModal",{toggleState:!0,message:Object(n.v)(e.message.replace(/\.$/,""))})):o("error","Could not join room: ".concat(e.message)))})},inviteToMatrixRoom:function(e,t){var o=e.commit,n=t.userId,i=t.roomId;r.invite(n,i).then(function(){}).catch(function(e){o("error","Could not send invite. ".concat(e))})},createMatrixRoom:function(e,t){var o=e.commit;r.createRoom(t).then(function(e){e.name=t.name,e.roomId=e.room_id,o("setMatrixLoggedIn",[e]),o("updateMatrixRoom",{roomId:e.roomId,values:{isHidden:"private"===t.visibility}}),o("toggleMatrixRoomModal",!1),o("selectMediaSource",{type:"matrix",id:e.room_id}),o("setLeftMenuTab","radio")}).catch(function(e){o("error","Could not create room. ".concat(e))})},createMatrixDirectMessageRoom:function(e,t){var o=e.commit;r.createDirectMessageRoom(t).then(function(e){o("error","Invited user ".concat(t," to chat with you.")),o("selectMediaSource",{type:"matrix",id:e.room_id}),o("setLeftMenuTab","matrix"),o("setMainLeftTab","matrix")}).catch(function(e){o("error","Could not send invite. ".concat(e))})},setRoomName:function(e,t){var o=e.commit,n=t.id,i=t.name;r.setRoomName(n,i).then(function(){return o("updateMatrixRoom",{roomId:n,values:{name:i}})}).catch(function(e){return o("error","Could not rename matrix room: ".concat(e))})},setRoomTag:function(e,t){var o=e.commit,n=t.roomId,i=t.tagName;r.setRoomTag(n,i).then(function(){return o("error",{error:"room tag is set",type:"success"})}).catch(function(e){return o("error","Could not set tagName. ".concat(e))})},updateRoomOptions:function(e,t){var o=e.commit;"allowGuests"in t&&r.setRoomAllowGuests(t.id,t.allowGuests).then(function(){return o("updateMatrixRoom",{roomId:t.id,values:{allowGuests:t.allowGuests}})}).catch(function(e){return o("error","Could not set allow guests to ".concat(t.allowGuests,". ").concat(e))}),"isHidden"in t&&r.setRoomVisibility(t.id,t.isHidden).then(function(){return o("updateMatrixRoom",{roomId:t.id,values:{isHidden:t.isHidden}})}).catch(function(e){return o("error","Could not set room private. ".concat(e))})},leaveMatrixRoom:function(e,t){var o=e.commit,n=e.state;o("deleteMatrixRoom",t),o("selectMediaSource",{type:"matrix",id:n.sourcesOrdered[0]}),r.leaveRoom(t).catch(function(){return o("error","Leaving matrix room failed")})},searchRoom:function(e,t){var o=e.commit;a("searchRoom",e.rootState,o,5e4),r.searchRoom(t).then(function(e){o("setRoomSearchResults",e)}).finally(function(){return o("toggleIsLoading",{id:"searchRoom",loading:!1})}).catch(function(e){return o("error","Searching for rooms failed. ".concat(e))})},updatePublicRooms:function(e){var t=e.commit;a("updatePublicRooms",e.rootState,t,5e4),r.searchRoom("audius").then(function(e){t("setPublicRooms",e.map(function(e){return{name:e.name.replace("[Audius]",""),id:e.room_id,numberOfMembers:e.num_joined_members,topic:e.topic}}))}).finally(function(){return t("toggleIsLoading",{id:"updatePublicRooms",loading:!1})}).catch(function(e){return t("error","Getting public matrix Rooms failed. ".concat(e))})},matrixLogout:function(e){var t=e.commit;r.logout(),t("matrixLogout")},parseMatrixMessages:function(e,t){e.state;var o=e.commit,r=e.rootState;t.forEach(function(e){var t=e.type,i=e.body;e.parse?Object(n.e)(i,r.youtubeApiKey,r.mediaIndex).then(function(t){var r=t.mediaList,n=t.newMedia;n.length&&o("updateMediaIndex",n),r.forEach(function(t){var r=Object.assign({},e,t);delete r.body,o("addChatlog",[r])})}):"text"!==t&&(e.id in r.mediaIndex||o("updateMediaIndex",e))}),o("addChatlog",t)}};function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var d=function(){return JSON.parse(JSON.stringify({name:"",playList:[],archive:[],members:0}))};var m=/@(.+):matrix.org/,l={},f={};function g(e,t){t.forEach(function(t){t.getJoinedMembers&&t.getJoinedMembers().forEach(function(t){var o=t.userId,r=t.name,i=r.match(m),a={userId:o,name:i?i[1]:r,nameColor:function(e){return"hsl(".concat(Object(n.j)(e)%360,",100%,30%)")}(r)};o in e.membersIndex?Object.assign(e.membersIndex[o],a):e.membersIndex[o]=a})}),e.membersIndex=Object.assign({},e.membersIndex)}var h={recoverState_matrix:function(e,t){Object.assign(e,t)},setPublicRooms:function(e,t){e.publicRooms=t},setMatrixCredentials:function(e,t){var o=t.credentials,r=t.isGuest;e.hasCredentials=!0,e.credentials=o,e.isGuest=r},joinRoom:function(e,t){var o=t.roomId;e.sourcesOrdered.includes(o)||(e.sourcesOrdered=[o].concat(u(e.sourcesOrdered))),o in e.sources?(console.log("room.status",t.getMyMembership()),e.sources[o].membership="join"):e.sources[o]=Object.assign({},d(),{name:t.name}),e.sources=Object.assign({},e.sources)},setMemberInfo:function(e,t){Object.assign(e.membersIndex[t.userId],t),e.membersIndex=Object.assign({},e.membersIndex)},setMatrixLoggedIn:function(e,t){e.showMatrixLoginModal=!1,e.matrixLoggedIn=!0,function(e,t){var o=e.credentials.userId;if(t.forEach(function(t){var r=t.roomId;r in e.sources||(e.sources[r]=Object.assign({},d(),{roomId:r,name:t.name})),e.sources[r].roomId=r,e.sources[r].members=t.getJoinedMembers().map(function(e){return{id:e.userId,powerLevel:e.powerLevel}}),e.sources[r].name=t.name,e.sources[r].avatarUrl=t.getAvatarUrl("https://matrix.org",200,200,"scale"),e.sources[r].membership=t.getMyMembership();var n=t.getDMInviter()?"directMessage":"room";"directMessage"===n&&(e.directMessages[t.getDMInviter()]=r,e.sources[r].name=t.name.replace(/@(\w+):.+/,"$1"),e.sources[r].avatarUrl=t.getMember(t.getDMInviter()).getAvatarUrl("https://matrix.org",200,200,"scale"));var i=t.currentState.getMembers();if("room"===n&&i.length<=2){var a=i.find(function(e){return e.getDMInviter()});a&&(n="directMessage",e.sources[r].avatarUrl=a.getAvatarUrl("https://matrix.org",200,200,"scale"))}e.sources[r].type=n;var s=t.getMember(o);e.sources[r].isAdmin=s.powerLevel>=100,e.sources[r].aliases=t.getAliases(),e.sourcesOrdered.includes(r)||e.sourcesOrdered.unshift(r)}),t.length>=1){var r=new Set(t.map(function(e){return e.roomId}));e.sourcesOrdered=u(e.sourcesOrdered.filter(function(e){return r.has(e)})).concat(u(t.filter(function(t){var o=t.roomId;return!e.sourcesOrdered.includes(o)})))}}(e,t),g(e,t)},toggleMatrixLoginModal:function(e,t){e.showMatrixLoginModal=void 0!==t?t:!e.showMatrixLoginModal},toggleMatrixRoomModal:function(e,t){e.createMatrixRoomModal=void 0!==t?t:!e.createMatrixRoomModal},toggleMatrixConsentModal:function(e,t){if("boolean"!=typeof t){var o=t.toggleState,r=t.message;r&&(e.matrixConsentMessage=r),e.showMatrixConsentModal=void 0!==o?o:!e.showMatrixConsentModal}else e.showMatrixConsentModal=t},toggleMatrixRoomDirectory:function(e,t){e.showMatrixRoomDirectory=void 0!==t?t:!e.showMatrixRoomDirectory},matrixRemoveAccount:function(e){Object.assign(e,{hasCredentials:!1,matrixLoggedIn:!1,isGuest:null,credentials:{accessToken:"",userId:"",deviceId:""}})},matrixLogout:function(e){e.matrixLoggedIn=!1,e.currentMatrixRoom=""},deleteMatrixRoom:function(e,t){e.sourcesOrdered=e.sourcesOrdered.filter(function(e){return e!==t}),delete e.sources[t]},toggleHideRoom:function(e,t){Object.assign(e.sources[t],{hidden:!e.sources[t].hidden}),e.sources=Object.assign({},e.sources)},moveMatrixSourcesOrdered:function(e,t){e.sourcesOrdered=t},updateMatrixRoom:function(e,t){var o=t.roomId,r=t.values;e.sources[o]||(e.sources[o]=Object.assign({},d(),{name:o})),e.sources[o]=Object.assign({},e.sources[o],r),e.sources=Object.assign({},e.sources)},setRoomSearchResults:function(e,t){e.roomSearchResults=t},setLastPageReached:function(e,t){e.lastPageReached[t]=!0},updateMatrixEvent:function(e,t){l[t.eventId].forEach(function(e){Object.assign(e,t.data)}),t.eventId!==t.data.eventId&&(l[t.data.eventId]=l[t.eventId]),e.sources=Object.assign({},e.sources)},matrixRedact:function(e,t){var o=t.eventId,r=t.roomId;r in e.chatLog&&(e.chatLog[r]=e.chatLog[r].filter(function(e){return e.eventId!==o}),e.chatLog=Object.assign({},e.chatLog)),r in e.sources&&(e.sources[r].playList=e.sources[r].playList.filter(function(e){return e.eventId!==o}),e.sources=Object.assign({},e.sources))},addChatlog:function(e,t){t.forEach(function(t){var o=t.roomId,r=t.type;t.eventId in l?l[t.eventId].push(t):l[t.eventId]=[t],o in e.sources||(e.sources[o]=Object.assign({},d(),{roomId:o,name:o})),o in f||(e.sources[o].playList=e.sources[o].playList.filter(function(e){return"object"===c(e)}).filter(function(e){var t=e.eventId;return!t||"~"!==t[0]}),f[o]=new Set(e.sources[o].playList.filter(function(e){return e.eventId}).map(function(e){return"".concat(e.eventId,"-").concat(e.id)})));var n="".concat(t.eventId,"-").concat(t.id);if("text"!==r&&!f[o].has(n)){var i=e.sources[o],a=i.playList,s=i.archive;for(f[o].add(n),a.push(t),a.sort(v),a.reverse();a.length>3e3;){var u=a.shift();s.push(u.id)}}var m=Object.assign(t,{childEvent:null,parentEvent:null});if(l[t.eventId].push(m),e.chatLog||(console.warn("This should not happen. state.chatLog is ",e.chatLog),e.chatLog={}),o in e.chatLog){var g=e.chatLog[o];g.push(m),g.sort(v),g.forEach(function(e,t){if(t){var o=g[t-1];o.createdAt===e.createdAt&&("text"!==o.type?++o.createdAt:++e.createdAt)}}),g.sort(v),g.forEach(function(e,t){if(t){var o=g[t-1];"text"===o.type&&"text"===e.type&&o.sender===e.sender?(o.childEvent=e,e.parentEvent=o):(o.childEvent=null,e.parentEvent=null)}})}else e.chatLog[o]=[m]}),e.sources=Object.assign({},e.sources),e.chatLog=Object.assign({},e.chatLog)}},v=function(e,t){return e.createdAt<=t.createdAt?-1:1},x=o(9),M=o(28);o.d(t,"actions",function(){return s}),o.d(t,"mutations",function(){return h}),o.d(t,"presistMutation",function(){return x.a}),o.d(t,"state",function(){return M.a})}}]);